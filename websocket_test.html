<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLMKG WebSocket Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #fff; 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-weight: bold; 
        }
        .connected { background: #004d00; color: #00ff00; }
        .disconnected { background: #4d0000; color: #ff4444; }
        .connecting { background: #4d4d00; color: #ffff44; }
        .metrics { 
            background: #333; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 4px;
            border-left: 4px solid #00ff00;
        }
        .metric-row { 
            display: flex; 
            justify-content: space-between; 
            margin: 5px 0; 
        }
        .metric-label { font-weight: bold; }
        .metric-value { color: #00ff88; }
        .log { 
            background: #222; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            height: 300px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px;
        }
        .timestamp { color: #888; }
        .brain-metrics { 
            background: #2d0040; 
            border-left-color: #ff00ff; 
        }
    </style>
</head>
<body>
    <h1>LLMKG Brain Server WebSocket Test</h1>
    
    <div id="status" class="status disconnected">
        Status: Disconnected
    </div>
    
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
    <button onclick="sendPing()">Send Ping</button>
    <button onclick="clearLog()">Clear Log</button>
    
    <div class="metrics" id="currentMetrics">
        <h3>Current Metrics</h3>
        <div id="systemMetrics">No data received yet</div>
    </div>
    
    <div class="metrics brain-metrics" id="brainMetrics">
        <h3>üß† Brain Metrics (Real LLMKG Data)</h3>
        <div id="brainData">No brain data received yet</div>
    </div>
    
    <div class="log" id="log">
        <div class="timestamp">[Starting WebSocket test...]</div>
    </div>

    <script>
        let ws = null;
        let messageCount = 0;
        let brainMetricsCount = 0;
        let startTime = Date.now();
        
        const WEBSOCKET_URL = 'ws://localhost:8081';
        
        function updateStatus(status, className) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = `Status: ${status}`;
            statusEl.className = `status ${className}`;
        }
        
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `<div><span class="timestamp">[${timestamp}]</span> ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('Already connected!');
                return;
            }
            
            updateStatus('Connecting...', 'connecting');
            log(`Attempting to connect to ${WEBSOCKET_URL}`);
            
            ws = new WebSocket(WEBSOCKET_URL);
            
            ws.onopen = function(event) {
                updateStatus('Connected', 'connected');
                log('‚úÖ <strong>WebSocket connection established!</strong>');
                log('Ready to receive real-time LLMKG metrics');
            };
            
            ws.onmessage = function(event) {
                messageCount++;
                
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.Pong) {
                        log(`üèì Pong response received`);
                    } else if (data.MetricsUpdate) {
                        log(`üìä MetricsUpdate #${messageCount} received (${event.data.length} bytes)`);
                        updateCurrentMetrics(data.MetricsUpdate);
                        updateBrainMetrics(data.MetricsUpdate);
                    } else {
                        log(`üì® Unknown message type: ${Object.keys(data)}`);
                    }
                    
                } catch (error) {
                    log(`‚ùå Error parsing message: ${error.message}`);
                }
            };
            
            ws.onclose = function(event) {
                updateStatus('Disconnected', 'disconnected');
                log(`‚ùå Connection closed (code: ${event.code}, reason: ${event.reason})`);
                
                const duration = Date.now() - startTime;
                log(`üìä Session stats: ${messageCount} messages in ${(duration/1000).toFixed(1)}s`);
            };
            
            ws.onerror = function(error) {
                updateStatus('Error', 'disconnected');
                log(`üî• WebSocket error: ${error}`);
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close(1000, 'User disconnect');
                ws = null;
            }
        }
        
        function sendPing() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const pingMessage = { Ping: null };
                ws.send(JSON.stringify(pingMessage));
                log('üì§ Ping sent to server');
            } else {
                log('‚ùå Cannot send ping - not connected');
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="timestamp">[Log cleared]</div>';
        }
        
        function updateCurrentMetrics(metrics) {
            const systemMetricsEl = document.getElementById('systemMetrics');
            const { system_metrics, application_metrics } = metrics;
            
            systemMetricsEl.innerHTML = `
                <div class="metric-row">
                    <span class="metric-label">CPU Usage:</span>
                    <span class="metric-value">${system_metrics.cpu_usage_percent.toFixed(2)}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Memory Usage:</span>
                    <span class="metric-value">${system_metrics.memory_usage_percent.toFixed(2)}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Operations/sec:</span>
                    <span class="metric-value">${application_metrics.operations_per_second || 0}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Timestamp:</span>
                    <span class="metric-value">${new Date(metrics.timestamp * 1000).toLocaleTimeString()}</span>
                </div>
            `;
        }
        
        function updateBrainMetrics(metrics) {
            const brainDataEl = document.getElementById('brainData');
            
            if (metrics.metrics) {
                const brainKeys = Object.keys(metrics.metrics).filter(k => k.startsWith('brain_'));
                
                if (brainKeys.length > 0) {
                    brainMetricsCount++;
                    
                    let brainHtml = `<div class="metric-row">
                        <span class="metric-label">üß† Updates Received:</span>
                        <span class="metric-value">${brainMetricsCount}</span>
                    </div>`;
                    
                    brainKeys.forEach(key => {
                        const displayName = key.replace('brain_', '').replace(/_/g, ' ');
                        const value = metrics.metrics[key];
                        brainHtml += `
                            <div class="metric-row">
                                <span class="metric-label">${displayName}:</span>
                                <span class="metric-value">${typeof value === 'number' ? value.toFixed(3) : value}</span>
                            </div>
                        `;
                    });
                    
                    brainHtml += `<div class="metric-row">
                        <span class="metric-label">‚úÖ Real LLMKG Data:</span>
                        <span class="metric-value">VERIFIED</span>
                    </div>`;
                    
                    brainDataEl.innerHTML = brainHtml;
                } else {
                    brainDataEl.innerHTML = '<div>No brain metrics in this update</div>';
                }
            } else {
                brainDataEl.innerHTML = '<div>No metrics object found</div>';
            }
        }
        
        // Auto-connect on page load
        window.onload = function() {
            log('Page loaded - ready to test WebSocket connection');
            setTimeout(connect, 1000); // Auto-connect after 1 second
        };
        
        // Clean up on page unload
        window.onbeforeunload = function() {
            if (ws) {
                ws.close(1000, 'Page unload');
            }
        };
    </script>
</body>
</html>